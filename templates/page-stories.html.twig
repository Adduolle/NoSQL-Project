{% extends 'base.html.twig' %}

{% block title %}Taleroom - Accueil{% endblock %}
{% block body %}
    {% for message in app.flashes('info') %}
        <div class="alert alert-info alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endfor %}
        <!--barre de navegation-->
        <header class="main-header">
            <nav class="navbar navbar-expand-sm navbar-light p-4">
                <a href="index.html"><img src="{{ asset('images/TaleRoom(1).png')}}" alt="TaleRoom"></a>

                <ul class="navbar-nav ml-auto">
                    <li class="nav-items user-profile">

                        <a class="nav-link" href="/profile">
                            <span class="user-name">{{ nickname }}</span> 
                        </a>
                        
                    </li>
                </ul>    
            </nav>
        </header>

        <main class="hero-content-center">

            <div class="container">
                <div class="row justify-content-center h-100">
                    {% if round > 0 %}
                        <div class="col-md-10 col-lg-10">
                            <div class="card tale-room-card">
                                <div class="card-body">

                                    <div class="scrollable-content-stories">
                                        <div id="stories-created">
                                            <div class="story-item ">
                                                <p class="story-text">{{ assigned_text }}</p>
                                            </div>
                                        </div>
                                    </div>

                                
                                </div>

                            </div>
                            <h1 class="title-suite">Ecrivez la suite de l'histoire :</h1>
                        </div>
                    {% else %}
                        <div class="col-md-10 col-lg-10">
                            <h1 class="title-suite">Ecrivez le début d'une histoire :</h1>
                        </div>
                    {% endif %}


                    <!--<form id="form-new-text" action="" method="POST">-->

                        <div class="text-contribution">
                            <div class="form-group">
                                <textarea class="form-control tale-room-textarea" 
                                name="playerstorie" 
                                id="playerstorie" 
                                rows="6" 
                                placeholder="Ecrivez votre partie de l'histoire..." 
                                required></textarea>
                            </div>
                            <div class="text-center mt-3">
                                <button id="submitAnswer" type="button" class="btn btn-sm tale-room-btn">
                                    Continuer histoire
                                </button>
                            </div>
                        </div>
                    <!--</form>-->

                </div>
            </div>


        </main>

<script>
    var postSent = false;
    var playersReady = false;
    var content='';
    const roomID = '{{ roomID }}';
    const url = `/game_loop/${roomID}/status`;

    async function refresh() {
        
        try {
            const response = await fetch(url);
            console.log("Réponse reçue :", response);
            const data = await response.json();
            console.log("Données reçues :", data);
            playersReady = data.allPlayed;
            
            if (playersReady){
                const response = await fetch(`/game_loop/${gameId}/${content}/recup`);
                const data = await response.json();
                
                if (data.success) {
                    content=data.content;
                    window.location.href = `/game_loop/`;
                } else {
                    console.error('Impossible de réinitialiser les joueurs', data);
                }
            }
        } catch (err) {
            console.error("Erreur lors du refresh des joueurs :", err);
        }
    }

    document.getElementById('submitAnswer').addEventListener('click',()=>{
        const button = document.getElementById('submitAnswer');
        button.disabled = true;
        button.textContent = "Waiting...";
        document.getElementById('playerstorie').disabled = true;
        content = document.getElementById('playerstorie').value;
        fetch(`/game_loop/${roomID}/validRound`);
        setInterval(refresh, 2000);
        refresh();
    })
</script>

{% endblock %}
